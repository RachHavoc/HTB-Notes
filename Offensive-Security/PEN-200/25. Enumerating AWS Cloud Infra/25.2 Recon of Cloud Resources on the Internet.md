### Accessing Lab

- Check DNS server on Kali

```
kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

- Add NS of lab DNS server to this file
```hlt:1,4,6
kali@kali:~$ sudo nano /etc/resolv.conf
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 44.205.254.229
nameserver 1.1.1.1
```
- Test DNS connection
```hlt:1,4
kali@kali:~$ host www.offseclab.io 44.205.254.229
www.offseclab.io has address 52.70.117.69

kali@kali:~$ host www.offseclab.io 
www.offseclab.io has address 52.70.117.69
```
- Reset DNS settings
```hlt:1,4
kali@kali:~$ sudo systemctl restart NetworkManager
[sudo] password for kali:

kali@kali:~$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```

### Domain and Subdomain Reconnaissance
Target domain name: **offseclab.io**

Get _authoritative_ DNS servers (name servers)
```hlt:1
kali@kali:~$ host -t ns offseclab.io
offseclab.io name server ns-1536.awsdns-00.co.uk.
offseclab.io name server ns-512.awsdns-00.net.
offseclab.io name server ns-0.awsdns-00.com.
offseclab.io name server ns-1024.awsdns-00.org.
```

Get Registrar Info for domain
```hlt:1
kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"
Registrant Organization: Amazon Technologies, Inc.
```

- Looks like **offseclab.io** domain is managed by AWS
- Likely using Route53 service 
- Can't assume full infrastructure is on AWS

Get public IP of www.offseclab[.]io
```hlt:1
kali@kali:~$ host www.offseclab.io
www.offseclab.io has address 52.70.117.69
```

Reverse DNS lookup of `52.70.117.69`
```hlt:1
kali@kali:~$ host 52.70.117.69
69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com
```
- Resource hosted in AWS
- Resource is Amazon Elastic Compute Cloud (EC2) instance
Learn OrgName of IP
```hlt:1
kali@kali:~$ whois 52.70.117.69 | grep "OrgName"
OrgName:        Amazon Technologies Inc.
```
- public IP belongs to Amazon

Use #dnsenum to perform subdirectory enumeration of offseclab.io
```hlt:1,10,15-18,42
kali@kali:~$ dnsenum offseclab.io --threads 100
dnsenum VERSION:1.2.6

-----   offseclab.io   -----


Host's addresses:
__________________

offseclab.io.                            60       IN    A        52.70.117.69

Name Servers:
______________

ns-1536.awsdns-00.co.uk.                 0        IN    A        205.251.198.0
ns-0.awsdns-00.com.                      0        IN    A        205.251.192.0
ns-512.awsdns-00.net.                    0        IN    A        205.251.194.0
ns-1024.awsdns-00.org.                   0        IN    A        205.251.196.0


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

Trying Zone Transfer for offseclab.io on ns-512.awsdns-00.net ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1024.awsdns-00.org ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-0.awsdns-00.com ...
AXFR record query failed: corrupt packet

Trying Zone Transfer for offseclab.io on ns-1536.awsdns-00.co.uk ...
AXFR record query failed: corrupt packet


Brute forcing with /usr/share/dnsenum/dns.txt:
_______________________________________________
mail.offseclab.io.                       60       IN    A        52.70.117.69
www.offseclab.io.                        60       IN    A        52.70.117.69
...
```
- got name servers and public IP address (from before)
- discovered subdomains

Summary of Recon:
- Domain is in AWS (probs using AWS Route53)
- Domain name resolves to public IP
- Public IP serves several websites running inside EC2 instance

### Service-Specific Domains

#### Scenario
Navigating to `[http://www.offseclab.io](http://www.offseclab.io/)`

Determine server-side scripting languages in use:
- Open Developer Tools > Click Network tab > Reload the page

![Figure 2: Opening the Developer Tools in Firefox](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/cfdb0e397c45cb2c7cb69885eb9bae80-firefox_dev_tools.png)

Results show
- (.css), (.js), (.png), (.jpg), etc.
- Browser requests these elements from `oofseclab.io`, fonts from external domains, and interestingly images from `s3.amazonaws.com`

![Figure 3: Getting the URL of the S3 Object](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/15bec2ed12be61e87d1ab3377de92021-cldenum_devtools.gif)

Click on images to reveal full resource path. 

Analyzing S3 URL for one of the images 
![Figure 4: Analyzing the S3 URL](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/ef691edbd2f53718e307245bed548997-offseclab_site_url.png)

- Images are stored in AWS S3 bucket 
- Path: `offseclab-assets-public-axevtewi/sites/www/images/amethyst.png`
	- S3 bucket name: `offseclab-assets-public-axevtewi`
	- Object key: `sites/www/images/ruby-expanded.png`

Attempt to list contents of bucket by browsing to the URL
![Figure 5: List the offseclab-assets-public Bucket](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/9c4bade368c4b012a5586039119d7460-list_pub_bucket.png)
- Received all key objects in bucket, but nothing useful for exploit
- Certain objects in bucket can be public w/o the whole bucket being public

Analyze bucket name: `offseclab-assets-public-axevtewi`
Assuming naming convention: org name, description of bucket, and a random string

Attempt to browse for buckets using this naming convention `offseclab-assets-dev`
![Figure 6: List the offseclab-assets-dev Bucket](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/8c071ec62162cebbeff226a014e06db8-list_dev_bucket.png)
Bucket doesn't exist. 

Try again with `offseclab-assets-private`
![Figure 7: List the offseclab-assets-private Bucket](https://static.offsec.com/offsec-courses/PEN-200/images/cloud_enum_1/e9757821f2fe6d6f42100f9e72a212bd-list_priv_bucket.png)
Access Denied. 

Automate this enumerating with the tools #cloudbrute or #cloud-enum
- [_cloudbrute_](https://www.kali.org/tools/cloudbrute/) 
- [_cloud-enum_](https://www.kali.org/tools/cloud-enum/)

|AWS|Azure|GCP|
|---|---|---|
|s3.amazonaws.com|web.core.windows.net|appspot.com|
|awsapps.com|file.core.windows.net|storage.googleapis.com|
||blob.core.windows.net||
||azurewebsites.net||
||cloudapp.net||
Custom URLs of All The Three Major CSPs

Automate enumeration of `offseclab.io` using #cloud-enum 

Update and install cloud-enum
```hlt:1,5
kali@kali:~$ sudo apt update
[sudo] password for kali:
...

kali@kali:~$ sudo apt install cloud-enum
[sudo] password for kali:
```

Truncated cloud-enum help menu 
```
kali@kali:~$ cloud_enum --help
usage: cloud_enum [-h] (-k KEYWORD | -kf KEYFILE) [-m MUTATIONS] [-b BRUTE]
                  [-t THREADS] [-ns NAMESERVER] [-l LOGFILE] [-f 
```

This tool searches through public CSPs.

Run quick scan against bucket name we know 
```
kali@kali:~$ cloud_enum -k offseclab-assets-public-axevtewi --quickscan --disable-azure --disable-gcp
```

Tool found bucket and listed contents of bucket. 

Create a wordlist to enumerate buckets based on the naming convention we discovered earlier. 
```hlt:1
kali@kali:~$ for key in "public" "private" "dev" "prod" "development" "production"; do echo "offseclab-assets-$key-axevtewi"; done | tee /tmp/keyfile.txt
offseclab-assets-public-axevtewi
offseclab-assets-private-axevtewi
offseclab-assets-dev-axevtewi
offseclab-assets-prod-axevtewi
offseclab-assets-development-axevtewi
offseclab-assets-production-axevtewi
```

Enumerate S3 buckets using this wordlist
```hlt:1,20
kali@kali:~$ cloud_enum -kf /tmp/keyfile.txt -qs --disable-azure --disable-gcp

...

Keywords:    offseclab-assets-public-axevtewi, offseclab-assets-private-axevtewi, offseclab-assets-dev-axevtewi, offseclab-assets-prod-axevtewi, offseclab-assets-development-axevtewi, offseclab-assets-production-axevtewi
Mutations:   NONE! (Using quickscan)
Brute-list:  /usr/lib/cloud-enum/enum_tools/fuzz.txt

[+] Mutated results: 6 items

++++++++++++++++++++++++++
      amazon checks
++++++++++++++++++++++++++

[+] Checking for S3 buckets
  OPEN S3 BUCKET: http://offseclab-assets-public-axevtewi.s3.amazonaws.com/
      FILES:
      ->http://offseclab-assets-public-axevtewi.s3.amazonaws.com/offseclab-assets-public-axevtewi

  Protected S3 Bucket: http://offseclab-assets-private-axevtewi.s3.amazonaws.com/
```

Discover protected bucket. 
